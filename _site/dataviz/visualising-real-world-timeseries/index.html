<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Visualising timeseries: stocks data and global trends &#8211; The many shades of data</title>
<meta name="description" content="A primer on dealing with mixtures of time-series and visualising them in a sensible way to prepare for the analysis of trends.  I'll use FTSE 100 stocks data from Quandl.">
<meta name="keywords" content="data visualisation, data analysis, R, ggplot2, stocks">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Visualising timeseries: stocks data and global trends">
<meta name="twitter:description" content="A primer on dealing with mixtures of time-series and visualising them in a sensible way to prepare for the analysis of trends.  I'll use FTSE 100 stocks data from Quandl.">
<meta name="twitter:site" content="@velvetbaldmime">
<meta name="twitter:creator" content="@velvetbaldmime">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_GB">
<meta property="og:type" content="article">
<meta property="og:title" content="Visualising timeseries: stocks data and global trends">
<meta property="og:description" content="A primer on dealing with mixtures of time-series and visualising them in a sensible way to prepare for the analysis of trends.  I'll use FTSE 100 stocks data from Quandl.">
<meta property="og:url" content="/dataviz/visualising-real-world-timeseries/">
<meta property="og:site_name" content="The many shades of data">

<meta property="og:image" content="/images/default-thumb.png">






<link rel="canonical" href="/dataviz/visualising-real-world-timeseries/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="The many shades of data Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="/assets/js/vendor/html5shiv.min.js"></script>
	<script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/">The many shades of data</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="/posts/" >Posts</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    


<div itemscope itemtype="http://schema.org/Person">


	<img src="/images/bio-photo.jpg" class="bio-photo" alt="Anton Sviridov bio photo">


  <h3 itemprop="name">Anton Sviridov</h3>
  <p>Aspiring data ninja</p>
  <a href="mailto:keynmol@gmail.com" class="author-social" target="_blank"><i class="fa fa-fw fa-envelope-square"></i> Email</a>
  <a href="http://twitter.com/velvetbaldmime" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  
  
  
  
  <a href="http://github.com/keynmol" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="/dataviz/visualising-real-world-timeseries/" rel="bookmark" title="Visualising timeseries: stocks data and global trends">Visualising timeseries: stocks data and global trends</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <section id="table-of-contents" class="toc">
  <header>
    <h3><i class="fa fa-book"></i> Overview</h3>
  </header>
<div id="drawer">
<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#getting-ftse-100-stocks" id="markdown-toc-getting-ftse-100-stocks">Getting FTSE 100 stocks</a></li>
  <li><a href="#getting-quandl-data-for-stocks" id="markdown-toc-getting-quandl-data-for-stocks">Getting Quandl data for stocks</a></li>
  <li><a href="#first-bad-plot" id="markdown-toc-first-bad-plot">First, bad plot</a></li>
  <li><a href="#normalisedbut-still-bad-plot" id="markdown-toc-normalisedbut-still-bad-plot">Normalised(but still bad) plot</a></li>
  <li><a href="#clustering-time-series" id="markdown-toc-clustering-time-series">Clustering time-series</a></li>
  <li><a href="#clustered-plot" id="markdown-toc-clustered-plot">Clustered plot</a></li>
  <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
</ul>

  </div>
</section>
<!-- /#table-of-contents -->

<h2 id="introduction">Introduction</h2>

<p>This most definitely won’t be a revelation for anyone working with time-series on a daily basis, but I came across the importance of proper techniques for visualising them quite recently in a work-related problem, so I decided to generalise the approach slightly and use publicly available data to demonstrate the importance of following method.</p>

<p>We will focus on the visualisation suitable for identifying global trends and patterns in timeseries of FTSE 100 stocks. Other applications might require different forms of visualisation.</p>

<p>It’s also worth mentioning that I am by no means an expert on the matter of stocks and financial markets(in fact everything I know was learnt in preparation for this post…), so any of my speculations should be taken with a bucketful of salt or ignored altogether. But if you have the urge to correct me, pleaso do so and I will alter the post.</p>

<p>We will start from the very beginning - mining stocks names from LSE website - and documenting each step as we go, with a few unexpected(but planned) twists and cheeky cliffhangers.</p>

<h2 id="getting-ftse-100-stocks">Getting FTSE 100 stocks</h2>
<p>Our main data will come from Quandl, which stores all LSE stocks in datasets that have names like “LSE/HIK” where “HIK” is the stock’s name. FTSE 100 aggregated top 100 performing stocks on LSE, so we can use it as a reference for the most interesting stocks. Let’s mine the stock names from LSE’s website.</p>

<p>Stock information is stored in HTML tables scattered across several pages with the same base url: “http://www.londonstockexchange.com/exchange/prices-and-markets/stocks/indices/summary/summary-indices-constituents.html?index=UKX&amp;page=1”. Varying the “page” parameter from 1 to 6 we can get all 100 stocks. The script is therefore extremely straightforward:</p>

<p><code>mine.py</code></p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://www.londonstockexchange.com/exchange/prices-and-markets/stocks/indices/summary/summary-indices-constituents.html?index=UKX&amp;page={0}&quot;</span>
<span class="n">stocks</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">stock_names</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">_stocks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;&lt;td scope=&quot;row&quot; class=&quot;name&quot;&gt;(.+?)&lt;/td&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">_stock_names</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;&lt;a.*title=&quot;View detailed prices page&quot; target=&quot;&quot;&gt;(.+?)&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="n">stocks</span> <span class="o">+=</span> <span class="n">_stocks</span>
    <span class="n">stock_names</span> <span class="o">+=</span> <span class="n">_stock_names</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;stock_codes.csv&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Stock, Name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span><span class="n">stock_names</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&quot;, &quot;&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span></code></pre></div>

<p>After it finishes, we get a little CSV file that looks something like this:</p>

<pre><code>Stock, Name
"III", "3I GRP."
"ABF", "A.B.FOOD"
"ADN", "ABDN.ASSET.MAN."
"ADM", "ADMIRAL GRP"
"AGK", "AGGREKO"
"AAL", "ANGLO AMERICAN"
"ANTO", "ANTOFAGASTA"
"ARM", "ARM HLDGS."
"AHT", "ASHTEAD GRP."
...
</code></pre>

<p>Names are not as important, but will come handy during visualisation time.</p>

<h2 id="getting-quandl-data-for-stocks">Getting Quandl data for stocks</h2>
<p>Having all the stocks names, we can now obtain the time-series describing how the stock price changed over time.</p>

<p>We will need to install the Quandl library for R(see <a href="https://www.quandl.com/help/r">installation instructions</a>, also worth setting up auth code to bypass 50-per-hour rate limits) and establish a portal to the <a href="http://adolfoalvarez.cl/the-hitchhikers-guide-to-the-hadleyverse/">Hadleyverse</a>:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># assuming you installed it</span>
<span class="kn">library</span><span class="p">(</span>Quandl<span class="p">)</span>

<span class="kn">library</span><span class="p">(</span>dplyr<span class="p">)</span> <span class="c1"># general data wrangling, tbl_df, %&gt;% operator</span>
<span class="kn">library</span><span class="p">(</span>stringr<span class="p">)</span> <span class="c1"># query tokenization</span>
<span class="kn">library</span><span class="p">(</span>lubridate<span class="p">)</span> <span class="c1"># could be omitted, really, but I do love it too much</span>
<span class="kn">library</span><span class="p">(</span>ggplot<span class="p">)</span> <span class="c1"># beautiful plots</span></code></pre></div>

<p>Now comes the more interesting part. As I said earlier, Quandl stores all the stocks data for LSE under codes like “LSE/AGK” - so running <code>Quandl("LSE/AGK")</code> will immediately give you a data frame with stock data for Aggreko. There’s two caveats though - one, FTSE 100 changes more often than Quandl’s LSE database, so some stocks might be missing. Two, some stocks from FTSE 100 have periods(“.”, e.g. “BP.”” is stock name for British Petroleum) in them, but Quandl doesn’t allow periods in datasets names.</p>

<p>To tackle problem number one we’ll wrap stock data extraction in a function that can handle retrieval errors gracefully. Second problem is not really a problem - we’ll just use <code>str_replace_all</code> to replace periods with underscores(“_”).</p>

<p>We will stack all the datasets for different stocks on top of each other to aid <code>ggplot</code> in plotting this data later on. Here’s the function that extracts stocks data for a vector of stocks names:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">quandle_stocks <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>stocks<span class="p">)</span> <span class="p">{</span>
  
  f <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">)</span>
    <span class="kp">tryCatch</span><span class="p">({</span>
      <span class="kp">print</span><span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;LSE&quot;</span><span class="p">,</span> x<span class="p">,</span> sep <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">))</span>
      <span class="kp">cbind</span><span class="p">(</span>Quandl<span class="p">(</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;LSE&quot;</span><span class="p">,</span> x<span class="p">,</span> sep <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="p">),</span> authcode <span class="o">=</span> API_CODE<span class="p">),</span> Stock <span class="o">=</span> x<span class="p">)</span> <span class="c1"># 2</span>
    <span class="p">},</span>
    error <span class="o">=</span> <span class="kr">function</span><span class="p">(</span>e<span class="p">)</span> <span class="p">{</span>
      <span class="kp">print</span><span class="p">(</span>e<span class="p">);</span> <span class="kc">NULL</span> <span class="c1"># 3</span>
    <span class="p">})</span>
  
  <span class="kp">do.call</span><span class="p">(</span><span class="kp">rbind</span><span class="p">,</span><span class="kp">lapply</span><span class="p">(</span>stocks<span class="p">,</span>f<span class="p">))</span> <span class="c1"># 1</span>
<span class="p">}</span></code></pre></div>

<p>Notes:</p>

<ol>
  <li>We apply <code>f</code> over a vector of stocks names, and then use <code>do.call</code> to call <code>rbind</code> with all the extracted data frames as positional arguments - this gives us a long data frame with all the stocks stacked on top of each other.</li>
  <li>Here we simply add stock’s name as a column to a dataset returned by <code>Quandl</code></li>
  <li>Any error with any particular stock will result in function returning <code>NULL</code>, which will then be handled gracefully by <code>rbind</code> - no data will simply be added to the resulting long data frame.</li>
</ol>

<p>Having this function, one can call it like this: <code>quandle_stocks(c("BP_", "AGK"))</code>. But we have already extracted all the stocks names we need, so let’s just use them keeping in mind the “.” vs. “_” issue.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">stock_codes <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;stock_codes.csv&quot;</span><span class="p">,</span> header<span class="o">=</span><span class="bp">T</span><span class="p">,</span> stringsAsFactors <span class="o">=</span> <span class="bp">F</span><span class="p">)</span>
all_stocks <span class="o">&lt;-</span> stock_codes<span class="o">$</span>Stock <span class="o">%&gt;%</span> 
                str_replace_all<span class="p">(</span><span class="s">&quot;\\.&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># replace &quot;.&quot; with &quot;_&quot;</span>
                quandle_stocks <span class="c1"># pipe that vector in the function we defined earlier</span></code></pre></div>

<p>Which, after outputting some debug information(e.g. errors in retrieving stocks “DC_”, “SKY” and “TUI” at the time of writing) will produce a dataset with following structure:</p>

<p><code>&gt; glimpse(all_stocks)</code></p>

<pre><code>Observations: 29217
Variables:
$ Date       (date) 2015-06-05, 2015-06-04, 2015-06-03, 2015-06-02, 2015-06-01, 2015-05-29, 2015-05-28, 2015-05-27, 2015-05-2...
$ Price      (dbl) 550.5, 554.0, 564.0, 568.5, 560.0, 559.5, 559.5, 562.5, 553.5, 551.5, 560.0, 558.0, 553.5, 548.0, 537.5, 5...
$ High       (dbl) 555.62, 563.00, 570.00, 571.00, 565.10, 567.14, 571.50, 562.50, 556.00, 559.00, 561.00, 561.50, 555.00, 55...
$ Low        (dbl) 548.50, 553.50, 561.50, 560.00, 554.20, 558.50, 559.00, 553.50, 547.50, 548.50, 554.50, 553.50, 546.90, 53...
$ Volume     (dbl) 1149139, 798015, 1850002, 2512969, 1756197, 1198987, 1763846, 875144, 1252053, 1318332, 710568, 1047121, 1...
$ Last Close (dbl) 554.5, 563.5, 569.5, 561.5, 560.5, 563.0, 564.5, 554.5, 550.0, 559.5, 560.0, 555.5, 548.0, 539.0, 534.5, 5...
$ Change     (dbl) 4.0, 9.5, 5.5, 7.0, 0.5, 3.5, 5.0, 8.0, 3.5, 8.0, 0.0, 2.5, 5.5, 9.0, 3.0, 6.5, 16.5, 5.0, 8.5, 12.0, 12.2...
$ Var%       (dbl) 0.72, 1.69, 0.97, 1.25, 0.09, 0.62, 0.89, 1.44, 0.64, 1.43, 0.00, 0.45, 1.00, 1.67, 0.56, 1.23, 3.22, 0.99...
$ Stock      (fctr) III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, III, ...
</code></pre>

<p>The columns we’re most interested in are <code>Date</code>, <code>Price</code> and <code>Stock</code>. Now, let’s get a feel of the date with increasingly better plots.</p>

<h2 id="first-bad-plot">First, bad plot</h2>
<p>First and most obvious way of plotting the stock data would be to treat it as timeseries - how the <code>Price</code> changes depending on the <code>Date</code>.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">all_stocks <span class="o">%&gt;%</span> ggplot<span class="p">(</span>aes<span class="p">(</span>Date<span class="p">,</span>Price<span class="p">,</span> colour <span class="o">=</span> Stock<span class="p">))</span> <span class="o">+</span> 
                    geom_line<span class="p">()</span> <span class="o">+</span> 
                    guides<span class="p">(</span>colour <span class="o">=</span> guide_legend<span class="p">(</span>ncol <span class="o">=</span> <span class="m">4</span><span class="p">))</span> <span class="o">+</span> 
                    theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size<span class="o">=</span><span class="m">14</span><span class="p">))</span> <span class="o">+</span> 
                    scale_x_date<span class="p">(</span>expand<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span> 
                    ggtitle<span class="p">(</span><span class="s">&quot;FTSE 100 stocks&quot;</span><span class="p">)</span></code></pre></div>

<p><img src="/assets/viz-stock-data/ugly_plot.png" alt="Ugly plot" /></p>

<p>It is obvious that this plot gives us a lot less information than the data actually contains - mainly due to horrifying amount of overlapping in the bottom part of the <code>Price</code> scale. It’s also less than obvious to understand what line belongs to which stock - the colour brewer scale of ggplot2 is only good when you have less than 5 groups.</p>

<p>One other thing will also become obvious on the subsequent plots - dramatic difference in stocks prices actually hides interesting trends.</p>

<h2 id="normalisedbut-still-bad-plot">Normalised(but still bad) plot</h2>
<p>Now, FTSE 100 aggregates stocks with varying performance - stocks trading at ~77£(<strong>LLOY</strong>) are there together with those trading at ~6800£(<strong>NXT</strong>). My first suspicion after looking at the first version of our plot was that trends in smaller stocks will be compressed until indistinguishable from a straight line by larger stocks displayed on the same scale.</p>

<p>For example, let’s take those two stocks, LLOY and NXT, and display them on the same plot(just like the one we used before).</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">all_stocks <span class="o">%&gt;%</span> filter<span class="p">(</span>Stock <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;NXT&quot;</span><span class="p">,</span> <span class="s">&quot;LLOY&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span> 
    ggplot<span class="p">(</span>aes<span class="p">(</span>Date<span class="p">,</span> Price<span class="p">,</span> colour<span class="o">=</span>Stock<span class="p">))</span> <span class="o">+</span> 
        geom_line<span class="p">()</span> <span class="o">+</span> 
        theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size<span class="o">=</span><span class="m">14</span><span class="p">))</span> <span class="o">+</span> 
        scale_x_date<span class="p">(</span>expand<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span> 
        ggtitle<span class="p">(</span><span class="s">&quot;FTSE 100 smallest stock vs. biggest stock&quot;</span><span class="p">)</span></code></pre></div>

<p><img src="/assets/viz-stock-data/lloy_vs_nxt.png" alt="LLOY vs. NXT" /></p>

<p>This example clearly shows the importance of scaling before plotting. In the end, for our analysis the absolute value matters less than the behaviour of the stock - how it changed relative to its minimum/maximum/average value(choose the appropriate descriptive statistic based on your application).</p>

<p>So it makes sense to normalise the stocks prices to identify the trends. Let’s do exactly that.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">normalise <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>stocks<span class="p">){</span>
   stocks <span class="o">%&gt;%</span> group_by<span class="p">(</span>Stock<span class="p">)</span> <span class="o">%&gt;%</span> 
        mutate<span class="p">(</span>Price <span class="o">=</span> <span class="p">(</span>Price<span class="o">-</span><span class="kp">min</span><span class="p">(</span>Price<span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="kp">max</span><span class="p">(</span>Price<span class="p">)</span> <span class="o">-</span> <span class="kp">min</span><span class="p">(</span>Price<span class="p">)))</span> <span class="o">%&gt;%</span> ungroup
<span class="p">}</span></code></pre></div>

<p>This function normalises each stock by representing it as a fraction of the price range - this new, normalised Price will be zero when the stock reaches its absolute minimum, and will be one when it reaches its absolute maximum. Let’s try and plot those new lines all on the same plot:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">normalise<span class="p">(</span>all_stocks<span class="p">)</span> <span class="o">%&gt;%</span> 
    ggplot<span class="p">(</span>aes<span class="p">(</span>Date<span class="p">,</span>Price<span class="p">,</span> colour <span class="o">=</span> Stock<span class="p">))</span> <span class="o">+</span> 
        geom_line<span class="p">()</span> <span class="o">+</span> 
        guides<span class="p">(</span>colour <span class="o">=</span> guide_legend<span class="p">(</span>ncol <span class="o">=</span> <span class="m">4</span><span class="p">))</span> <span class="o">+</span> 
        theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size<span class="o">=</span><span class="m">14</span><span class="p">))</span> <span class="o">+</span> 
        scale_x_date<span class="p">(</span>expand<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span> 
        ggtitle<span class="p">(</span><span class="s">&quot;FTSE 100 stocks(normalised)&quot;</span><span class="p">)</span></code></pre></div>

<p><img src="/assets/viz-stock-data/ugly_normalised_plot.png" alt="Bad normalised plot" /></p>

<p>On the first sight it looks as if the plot only got worse. It’s certainly less pretty, but let’s take a look at what happened to the lines corresponding to LLOY and NXT:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">normalise<span class="p">(</span>all_stocks<span class="p">)</span> <span class="o">%&gt;%</span> filter<span class="p">(</span>Stock <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;NXT&quot;</span><span class="p">,</span> <span class="s">&quot;LLOY&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span> 
    ggplot<span class="p">(</span>aes<span class="p">(</span>Date<span class="p">,</span> Price<span class="p">,</span> colour<span class="o">=</span>Stock<span class="p">))</span> <span class="o">+</span> 
        geom_line<span class="p">()</span> <span class="o">+</span> 
        theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size<span class="o">=</span><span class="m">14</span><span class="p">))</span> <span class="o">+</span> 
        scale_x_date<span class="p">(</span>expand<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span> 
        ggtitle<span class="p">(</span><span class="s">&quot;FTSE 100 smallest stock vs. biggest stock(normalised&quot;</span><span class="p">)</span></code></pre></div>

<p><img src="/assets/viz-stock-data/lloy_vs_nxt_normalised.png" alt="LLOY vs. NXT normalised" /></p>

<p>Much better, isn’t it? For the purposes of trend analysis - this representation is much more preferrable. If you were to invest in FTSE 100 stocks, you’d invest proportionally to the sizes of the stocks and then only care about the dynamics of your relative investments - not the absolute value for each stock.</p>

<p>This representation lets us identify periods of steady growth and compare speeds of growth between stocks of any value. The absolute value of the stock comes later on when the investment portfolio is being formed.</p>

<p>Also, this plot identifies some significant problems with the data. A careful observer will notice straight lines running across the plot - these are signs of missing data points. We will address this problem later.</p>

<h2 id="clustering-time-series">Clustering time-series</h2>
<p>Now, we can make a bold assumption that certain stocks behave similarly to other stocks - for example there must be a significant amount of steady risers - stocks that have been growing linearly and consistently until the last data point recorded. Also we’d expect to see several stocks that took a big hit from which they are recovering with varying success.</p>

<p>All those assumptions can be expressed graphically - how certain lines on our big messy plot are similar to other lines. It only makes sense to group them together and separate the plot into several smaller ones that only concentrate on similar stocks.</p>

<p>We’ll define clusters of stock behaviour. First thing one needs to address is that clustering algorithms impose a strict rule on the number of dimensions for each data point - it must be the same across all data points. It’s not the case in our data, as the histogram below will show, some stocks have more recorded data points, some - less.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">all_stocks <span class="o">%&gt;%</span> 
    count<span class="p">(</span>Stock<span class="p">)</span> <span class="o">%&gt;%</span> 
    ggplot<span class="p">(</span>aes<span class="p">(</span>n<span class="p">))</span> <span class="o">+</span> 
        geom_histogram<span class="p">(</span>binwidth<span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> 
        xlab<span class="p">(</span><span class="s">&quot;Number of data points&quot;</span><span class="p">)</span> <span class="o">+</span> 
        ylab<span class="p">(</span><span class="s">&quot;Number of stocks&quot;</span><span class="p">)</span> <span class="o">+</span> 
        theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size<span class="o">=</span><span class="m">14</span><span class="p">))</span></code></pre></div>

<p><img src="/assets/viz-stock-data/data_per_stock.png" alt="Data points per stock" /></p>

<p>Even though the majority of stocks has more than 300 data points(in fact 75% of stocks have more than 305), the numbers still vary, plus there’s plenty of stocks with significantly fewer data.</p>

<p>For any form of clustering to be applied we need to convert all those data points into a fixed number of dimensions, say, 100. To do that, we’ll use approximated function of stocks behaviour and its values at 100 points taken over a regular grid. First, let’s become acquainted with the <code>approxfun</code> function from base R. Take a look at the example:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">points <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0.5</span><span class="p">,</span><span class="m">1</span><span class="p">)</span>
values <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="m">0.8</span><span class="p">,</span> <span class="m">0.3</span><span class="p">,</span> <span class="m">0.9</span><span class="p">)</span>

new_points <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span><span class="m">0.1</span><span class="p">,</span><span class="m">0.2</span><span class="p">,</span><span class="m">0.9</span><span class="p">,</span><span class="m">0.94</span><span class="p">)</span>
approximated_function <span class="o">&lt;-</span> approxfun<span class="p">(</span>points<span class="p">,</span> values<span class="p">)</span>

new_values <span class="o">&lt;-</span> approximated_function<span class="p">(</span>new_points<span class="p">)</span></code></pre></div>

<p><code>approxfun</code> simply approximates the function given points and function’s values at those points and then returns a new function which can then be directly used to get values at a new set of points. For our purposes I think it’s good enough. Note, that we could’ve re-written the entire example as <code>approxfun(c(0,0.5,1), c(0.8, 0.3, 0.9))(c(0.1,0.2,0.9,0.94))</code> and it would give the same result as <code>new_values</code>. That’s the notation we’ll use for brevity later.</p>

<p>Now, given that we are about to compress the date axis of each stock to the same scale, it’s no longer appropriate to use actual dates, we’ll use numbers from 0.0 to 1.0 instead, where 0.0 is the first data point for stock, and 1.0 is the last one. We will then use <code>approxfun</code> and a fixed grid of points to get a decent approximation of what each stock’s behaviour looks like as a 100-dimensional vector.</p>

<p>So let’s write a function that compresses our stock data points into a fixed dimensionality vector.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">smooth <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>stock<span class="p">,</span> ndim<span class="o">=</span><span class="m">100</span><span class="p">){</span>
  normalise<span class="p">(</span>stock<span class="p">)</span> <span class="o">%&gt;%</span> group_by<span class="p">(</span>Stock<span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 1</span>
    arrange<span class="p">(</span>Date<span class="p">)</span> <span class="o">%&gt;%</span>
    mutate<span class="p">(</span>NormDate <span class="o">=</span> <span class="p">(</span><span class="kp">as.numeric</span><span class="p">(</span>Date<span class="p">)</span><span class="o">-</span><span class="kp">min</span><span class="p">(</span><span class="kp">as.numeric</span><span class="p">(</span>Date<span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="kp">max</span><span class="p">(</span><span class="kp">as.numeric</span><span class="p">(</span>Date<span class="p">))</span><span class="o">-</span><span class="kp">min</span><span class="p">(</span><span class="kp">as.numeric</span><span class="p">(</span>Date<span class="p">))))</span> <span class="o">%&gt;%</span> <span class="c1">#2</span>
    do<span class="p">(</span><span class="kt">data_frame</span><span class="p">(</span>Stock<span class="o">=</span><span class="m">.</span><span class="o">$</span>Stock<span class="p">[</span><span class="m">1</span><span class="p">],</span> 
                  Point<span class="o">=</span><span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span> length.out<span class="o">=</span>ndim<span class="p">),</span> <span class="c1">#3</span>
                  Price<span class="o">=</span>approxfun<span class="p">(</span><span class="m">.</span><span class="o">$</span>NormDate<span class="p">,</span> <span class="m">.</span><span class="o">$</span>Price<span class="p">)(</span><span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span> length.out<span class="o">=</span>ndim<span class="p">))))</span> <span class="o">%&gt;%</span> <span class="c1">#4</span>
    ungroup
<span class="p">}</span></code></pre></div>

<p>Notes:</p>

<ol>
  <li>We use the <code>normalise</code> function we defined earlier to scale prices.</li>
  <li>We convert each actual Date object to number from 0.0 to 1.0</li>
  <li>A grid of <code>ndim</code>(100) points over [0.0, 1.0]</li>
  <li>See example above, we basically approximate the Price as a function of normalised date and then evaluate this function on a regular grid of 100 points.</li>
</ol>

<p>Now, let’s take a look at LLOY and NXT stocks in this representation to make sure that our smoothing actually worked as expected:</p>

<p><img src="/assets/viz-stock-data/lloy_vs_nxt_smoothed.png" alt="LLOY vs. NXT smoothed" /></p>

<p>Looks good to me! Sure, we lost some detail by performing an under-sampling(100 points instead of ~325 in original data), but we managed to capture the main trends. And now we can use this data directly in any clustering algorithm.</p>

<p>Well, almost directly. Most clustering algorithms available in R will expect data in the shape of a matrix, where columns represent variables and rows represent observations. Our data is… well, somewhat different. Here’s what it looks like right now:</p>

<p><code>&gt; smooth(all_stocks)</code></p>

<pre><code>Source: local data frame [9,800 x 3]

   Stock      Point     Price
1    III 0.00000000 0.1692308
2    III 0.01010101 0.2132190
3    III 0.02020202 0.2398376
4    III 0.03030303 0.2243627
5    III 0.04040404 0.2448004
6    III 0.05050505 0.2379277
7    III 0.06060606 0.1789759
8    III 0.07070707 0.2052786
9    III 0.08080808 0.1417550
10   III 0.09090909 0.1376494
..   ...        ...       ...
</code></pre>

<p>What we want is for each Stock to spread the 100 values of Price into 100 different columns. Let’s use <code>tidyr</code>’s conveniently named <code>spread</code> function:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">smooth<span class="p">(</span>stock<span class="p">)</span> <span class="o">%&gt;%</span> group_by<span class="p">(</span>Stock<span class="p">)</span> <span class="o">%&gt;%</span> 
    arrange<span class="p">(</span>Point<span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 1</span>
    mutate<span class="p">(</span>P<span class="o">=</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;P&quot;</span><span class="p">,</span> str_pad<span class="p">(</span>dense_rank<span class="p">(</span>Point<span class="p">),</span> <span class="m">4</span><span class="p">,</span> pad<span class="o">=</span><span class="s">&quot;0&quot;</span><span class="p">)))</span> <span class="o">%&gt;%</span> <span class="c1"># 2</span>
    select<span class="p">(</span><span class="o">-</span>Stock<span class="p">,</span> <span class="o">-</span>Point<span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1"># 3</span>
    spread<span class="p">(</span>P<span class="p">,</span> Price<span class="p">)</span> <span class="c1"># 4</span></code></pre></div>

<p>Notes:</p>

<ol>
  <li>I always sort the points in groups because I’m severely paranoid and I think I once was bitten by this. May be it was a dream. Better safe than sorry.</li>
  <li>I added a fake column whose values will become new column names</li>
  <li>We help <code>spread</code> by only leaving the new variable names and their values</li>
  <li>This “zips” fake column names with their respective values and then performs the transformation.</li>
</ol>

<p>Our data will now look like this:</p>

<pre><code>Source: local data frame [19 x 101]

   Stock     P 0001     P 0002     P 0003     P 0004     P 0005     P 0006     P 0007     P 0008     P 0009      P 0010     P 0011
1    HIK 0.00000000 0.04778993 0.10322777 0.12273866 0.14169262 0.18948128 0.16580846 0.24235589 0.30799727 0.284597858 0.31711855
2   HSBA 0.75647172 0.92336355 0.80954318 0.70199599 0.65978093 0.55019030 0.37168424 0.31514570 0.44932547 0.488567361 0.49434905
3    IMT 0.04666057 0.09154676 0.07972682 0.12534309 0.15955530 0.16854732 0.10621309 0.12498267 0.11539919 0.119021875 0.11380964
4    IHG 0.10749507 0.11423406 0.05818540 0.07270934 0.07175303 0.04342239 0.02097902 0.02719503 0.05718925 0.064042795 0.07073696
5   ITRK 0.80126183 0.85571806 0.92242084 0.83471943 0.94544817 0.94587303 0.82372622 0.83618520 0.87725839 0.964757990 0.91272345
6    IAG 0.41821809 0.44404064 0.43303044 0.42396035 0.41451080 0.39526247 0.35026797 0.38693786 0.31710724 0.337080916 0.39977232
7   INTU 0.36016949 0.35433787 0.36468855 0.26836158 0.26954931 0.08926126 0.10156651 0.11296225 0.08378274 0.044087057 0.09383025
8    ITV 0.37619048 0.38984127 0.32832131 0.29688312 0.30279942 0.26889851 0.23904762 0.31189033 0.22582973 0.193766234 0.24810967
9   JMAT 0.66908213 0.67400454 0.65822476 0.64273166 0.63087396 0.55390865 0.39013322 0.48477529 0.45874201 0.617698726 0.66666667
10   KGF 0.58982412 0.67195828 0.68981904 0.66554363 0.73966423 0.73772270 0.73540049 0.78666058 0.76612228 0.840452261 0.95793361
11  LAND 0.20612813 0.11443122 0.11493768 0.08213050 0.09186573 0.05783930 0.07942939 0.02827720 0.06225674 0.123676880 0.15188093
12  LGEN 0.34033149 0.38640549 0.40861655 0.38844802 0.37599196 0.33516379 0.25578436 0.08474803 0.03182097 0.002611753 0.07527206
13  LLOY 0.57475083 0.63578895 0.57077419 0.61985302 0.54778684 0.58262022 0.41383939 0.45179368 0.41418057 0.191902413 0.31068157
14   LSE 0.19591346 0.28328052 0.31778118 0.30364948 0.30124563 0.28670115 0.16881556 0.29108392 0.24732906 0.257320804 0.27684295
15   MKS 0.47507056 0.52756991 0.56277260 0.56042076 0.56305767 0.46727387 0.36477665 0.41573306 0.33162291 0.326121041 0.40839249
16  MGGT 0.59240821 0.54345100 0.51462352 0.46993268 0.44094963 0.26641650 0.14006902 0.27135072 0.24925044 0.312930173 0.32273576
17  MERL 0.25826772 0.30858984 0.36876906 0.35025054 0.25425117 0.33176648 0.45058459 0.37253374 0.37851746 0.365282749 0.38504732
18  MNDI 0.06233766 0.15798242 0.18095238 0.21605667 0.25892693 0.25929424 0.21978224 0.22172373 0.17453321 0.151305260 0.20829070
19   MRW 0.91309131 0.87508751 0.95967375 0.91279128 0.90619062 0.89724528 0.60376038 0.62776278 0.64938716 0.675434210 0.59409274
Variables not shown: P 0012 (dbl), P 0013 (dbl), P 0014 (dbl), P 0015 (dbl), P 0016 (dbl), P 0017 (dbl), P 0018 (dbl), P 0019 (dbl),
  P 0020 (dbl), P 0021 (dbl), P 0022 (dbl), P 0023 (dbl), P 0024 (dbl), P 0025 (dbl), P 0026 (dbl), P 0027 (dbl), P 0028 (dbl), P
  0029 (dbl), P 0030 (dbl), P 0031 (dbl), P 0032 (dbl), P 0033 (dbl), P 0034 (dbl), P 0035 (dbl), P 0036 (dbl), P 0037 (dbl), P 0038
  (dbl), P 0039 (dbl), P 0040 (dbl), P 0041 (dbl), P 0042 (dbl), P 0043 (dbl), P 0044 (dbl), P 0045 (dbl), P 0046 (dbl), P 0047
  (dbl), P 0048 (dbl), P 0049 (dbl), P 0050 (dbl), P 0051 (dbl), P 0052 (dbl), P 0053 (dbl), P 0054 (dbl), P 0055 (dbl), P 0056
  (dbl), P 0057 (dbl), P 0058 (dbl), P 0059 (dbl), P 0060 (dbl), P 0061 (dbl), P 0062 (dbl), P 0063 (dbl), P 0064 (dbl), P 0065
  (dbl), P 0066 (dbl), P 0067 (dbl), P 0068 (dbl), P 0069 (dbl), P 0070 (dbl), P 0071 (dbl), P 0072 (dbl), P 0073 (dbl), P 0074
  (dbl), P 0075 (dbl), P 0076 (dbl), P 0077 (dbl), P 0078 (dbl), P 0079 (dbl), P 0080 (dbl), P 0081 (dbl), P 0082 (dbl), P 0083
  (dbl), P 0084 (dbl), P 0085 (dbl), P 0086 (dbl), P 0087 (dbl), P 0088 (dbl), P 0089 (dbl), P 0090 (dbl), P 0091 (dbl), P 0092
  (dbl), P 0093 (dbl), P 0094 (dbl), P 0095 (dbl), P 0096 (dbl), P 0097 (dbl), P 0098 (dbl), P 0099 (dbl), P 0100 (dbl)
</code></pre>

<p>Now this data can be used in a clustering algorithm, if we convert it to a proper matrix first. Let’s arrange the previous spreading step and the clsutering into one nice function:</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">cluster_stocks <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>stock<span class="p">,</span> N<span class="o">=</span><span class="m">2</span><span class="p">){</span>
  smooth<span class="p">(</span>stock<span class="p">)</span> <span class="o">%&gt;%</span> group_by<span class="p">(</span>Stock<span class="p">)</span> <span class="o">%&gt;%</span> 
    arrange<span class="p">(</span>Point<span class="p">)</span> <span class="o">%&gt;%</span> 
    mutate<span class="p">(</span>P<span class="o">=</span><span class="kp">paste</span><span class="p">(</span><span class="s">&quot;P&quot;</span><span class="p">,</span> str_pad<span class="p">(</span>dense_rank<span class="p">(</span>Point<span class="p">),</span> <span class="m">4</span><span class="p">,</span> pad<span class="o">=</span><span class="s">&quot;0&quot;</span><span class="p">)))</span> <span class="o">%&gt;%</span> 
    select<span class="p">(</span><span class="o">-</span>Stock<span class="p">,</span> <span class="o">-</span>Point<span class="p">)</span> <span class="o">%&gt;%</span> 
    spread<span class="p">(</span>P<span class="p">,</span> Price<span class="p">)</span> <span class="o">%&gt;%</span> 
    ungroup <span class="o">%&gt;%</span> 
    do<span class="p">(</span><span class="kt">data_frame</span><span class="p">(</span>Stock<span class="o">=</span><span class="m">.</span><span class="o">$</span>Stock<span class="p">,</span> 
                  Cluster <span class="o">=</span> kmeans<span class="p">(</span><span class="kp">as.matrix</span><span class="p">(</span>select<span class="p">(</span><span class="m">.</span><span class="p">,</span> <span class="o">-</span>Stock<span class="p">)),</span> N<span class="p">)</span><span class="o">$</span>cluster<span class="p">))</span>
<span class="p">}</span></code></pre></div>

<p>Notes:
 1. Here we just run basic <code>kmeans</code> algorithm on the matrix with all data points for stocks and a given number of clusters. We remove the column “Stock” and use <code>as.matrix</code> to simplify our object. Then we take the cluster numbers and return them in a new column.</p>

<p>Here’s the sample result:</p>

<p><code>&gt; cluster_stocks(all_stocks, N=10)</code></p>

<pre><code>Source: local data frame [98 x 2]

   Stock Cluster
1    III       6
2    ABF       3
3    ADN       4
4    ADM       4
5    AGK       1
6    AAL       8
7   ANTO       7
8    ARM       2
9    AHT      10
10   AZN       3
..   ...     ...
</code></pre>

<h2 id="clustered-plot">Clustered plot</h2>
<p>Now we can use clustering information to group similar stocks together. Let’s just create facets for each cluster and plot only stocks belonging to that cluster. For each cluster we will also display a line that best represents the pattern shared by the stocks in it - we’ll use <code>geom_smooth</code> for that.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r">normalise<span class="p">(</span>all_stocks<span class="p">)</span> <span class="o">%&gt;%</span> 
  inner_join<span class="p">(</span>cluster_stocks<span class="p">(</span>all_stocks<span class="p">,</span> N<span class="o">=</span><span class="m">9</span><span class="p">))</span> <span class="o">%&gt;%</span> 
  ggplot<span class="p">(</span>aes<span class="p">(</span>Date<span class="p">,</span> Price<span class="p">,</span> colour <span class="o">=</span> Stock<span class="p">))</span> <span class="o">+</span> 
    geom_line<span class="p">(</span>alpha<span class="o">=</span><span class="m">0.7</span><span class="p">)</span> <span class="o">+</span> 
    geom_smooth<span class="p">(</span>aes<span class="p">(</span>group<span class="o">=</span>Cluster<span class="p">),</span> size<span class="o">=</span><span class="m">2</span><span class="p">,</span> alpha<span class="o">=</span><span class="m">0.0</span><span class="p">)</span> <span class="o">+</span>
    guides<span class="p">(</span>colour <span class="o">=</span> guide_legend<span class="p">(</span>ncol <span class="o">=</span> <span class="m">4</span><span class="p">))</span> <span class="o">+</span> 
    theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size<span class="o">=</span><span class="m">14</span><span class="p">),</span> strip.text<span class="o">=</span>element_text<span class="p">(</span>size<span class="o">=</span><span class="m">17</span><span class="p">))</span> <span class="o">+</span> 
    scale_x_date<span class="p">(</span>expand<span class="o">=</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">))</span> <span class="o">+</span> 
    ggtitle<span class="p">(</span><span class="s">&quot;FTSE 100 stocks(normalised and clustered)&quot;</span><span class="p">)</span> <span class="o">+</span> 
    facet_wrap<span class="p">(</span><span class="o">~</span>Cluster<span class="p">)</span></code></pre></div>

<p>And here it is, the final plot:</p>

<p><img src="/assets/viz-stock-data/clustered-plot.png" alt="FTSE 100 stocks, normalised and clustered" /></p>

<h2 id="conclusion">Conclusion</h2>
<p>Even this simple plot shows us some interesting differences between stocks and how they recover from drops - stocks in cluster number 2 are less desirable than stocks in cluster number 9, as the latter ones seem to recover steadily form the hit. Is cluster number 2 just a stretched out version of first 50% of data points of cluster number 1?</p>

<p>Many interesting insights can be drawn just from looking at stocks in this grouped manner. Interesting clusters can then be examined more thoroughly on an absolute price plot.</p>

<p>Many other clustering techniques can be used, and I would especially recommend interactive hierarchical clustering to define a good number of cluster.</p>

<p>Code can be found in the <a href="https://github.com/keynmol/keynmol.github.io/tree/master/code/viz-stock-data">accompanying Github repo</a>.</p>

<p>Thanks for getting this far!</p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=/dataviz/visualising-real-world-timeseries/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=/dataviz/visualising-real-world-timeseries/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=/dataviz/visualising-real-world-timeseries/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Visualising timeseries: stocks data and global trends</strong> was published on <time datetime="2015-06-10T00:00:00+01:00">June 10, 2015</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="/data%20analysis/data-analysis-vs-google-search-history/" title="Data Analysis vs. Google search history">Data Analysis vs. Google search history</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    

<span>&copy; 2015 Anton Sviridov. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




</body>
</html>
